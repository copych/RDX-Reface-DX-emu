// RDX_Constants.h
#pragma once
#include <stdint.h>
#include "misc.h"

#include <array>
#include <cmath>

constexpr float DIV_SAMPLE_RATE = 1.0f / (float)SAMPLE_RATE;
constexpr float DIV_DMA_BUFFER_LEN = 1.0f / (float)DMA_BUFFER_LEN;
constexpr float MIDI_NORM = 1.0f / 127.0f;

#define ONE_DIV_SQRT2 0.707106781f
#define ONE_DIV_SQRT3 0.577350269f

// ================== CONFIG ==================
#ifndef SINLUT_SIZE
#define SINLUT_SIZE 1024   // must be power of two
#endif
// ============================================


constexpr float AEG_LEVEL[192] = {
0.0000, 14.3579, 19.6135, 23.5395, 26.7929, 29.6230, 32.1559, 34.4656,
36.6001, 38.5923, 40.4662, 42.2395, 43.9262, 45.5372, 47.0814, 48.5661,
49.9972, 51.3800, 52.7187, 54.0171, 55.2784, 56.5055, 57.7009, 58.8667,
60.0050, 61.1174, 62.2057, 63.2712, 64.3151, 65.3388, 66.3432, 67.3294,
68.2982, 69.2506, 70.1871, 71.1087, 72.0159, 72.9093, 73.7895, 74.6571,
75.5125, 76.3563, 77.1888, 78.0105, 78.8217, 79.6228, 80.4143, 81.1963,
81.9692, 82.7333, 83.4889, 84.2362, 84.9755, 85.7070, 86.4309, 87.1476,
87.8571, 88.5596, 89.2554, 89.9447, 90.6275, 91.3041, 91.9747, 92.6393,
93.2982, 93.9514, 94.5991, 95.2414, 95.8785, 96.5104, 97.1373, 97.7593,
98.3766, 98.9891, 99.5970, 100.2004, 100.7995, 101.3941, 101.9846, 102.5709,
103.1532, 103.7314, 104.3058, 104.8763, 105.4430, 106.0060, 106.5654, 107.1213,
107.6736, 108.2225, 108.7680, 109.3102, 109.8491, 110.3848, 110.9174, 111.4468,
111.9732, 112.4966, 113.0170, 113.5345, 114.0491, 114.5610, 115.0700, 115.5763,
116.0799, 116.5809, 117.0792, 117.5749, 118.0681, 118.5588, 119.0471, 119.5329,
120.0163, 120.4973, 120.9760, 121.4524, 121.9265, 122.3984, 122.8680, 123.3355,
123.8008, 124.2640, 124.7251, 125.1842, 125.6411, 126.0961, 126.5490, 127.0000,
127.4490, 127.8961, 128.3413, 128.7847, 129.2261, 129.6658, 130.1036, 130.5396,
130.9738, 131.4063, 131.8371, 132.2661, 132.6935, 133.1192, 133.5432, 133.9656,
134.3864, 134.8055, 135.2231, 135.6391, 136.0535, 136.4664, 136.8778, 137.2877,
137.6961, 138.1030, 138.5085, 138.9125, 139.3151, 139.7162, 140.1160, 140.5144,
140.9114, 141.3070, 141.7013, 142.0942, 142.4859, 142.8762, 143.2652, 143.6529,
144.0394, 144.4246, 144.8085, 145.1912, 145.5727, 145.9529, 146.3320, 146.7098,
147.0865, 147.4620, 147.8363, 148.2095, 148.5815, 148.9524, 149.3221, 149.6908,
150.0583, 150.4248, 150.7901, 151.1544, 151.5176, 151.8797, 152.2408, 152.6009
};

//------------------------- GAIN --------------------------------------------


constexpr inline float mapLevel(float level) {
    // 48 dB range
    return powf(10.0f, -((127 - level) * 48.0f) / (20.0f * 127.0f)) - 0.003981071705533f; 

    // polynomial approximation
    float level2 = level * level;
    return (3.49752e-07f * level2 * level + 2.61634e-06f * level2 + 1.90001e-03f * level);
}

constexpr int LEVEL_LUT_SIZE = 192; // 0..191 inclusive

struct LevelLUT {
    std::array<float, LEVEL_LUT_SIZE> forward{};
    std::array<float, LEVEL_LUT_SIZE> inverse{};
    float maxValue{};
};

constexpr LevelLUT buildLevelLUT() {
    LevelLUT lut{};
    // forward
    for (int i = 0; i < LEVEL_LUT_SIZE; ++i) {
        lut.forward[i] = mapLevel((float)i);
    }
    lut.forward[0] = 0.0f; // not to deal with tiny floats like 1.21352465e-43
    lut.maxValue = lut.forward[LEVEL_LUT_SIZE - 1];

    // inverse
    for (int i = 0; i < LEVEL_LUT_SIZE; ++i) {
        float target = (lut.maxValue * i) / (LEVEL_LUT_SIZE - 1);

        int lo = 0, hi = LEVEL_LUT_SIZE - 1;
        while (hi - lo > 1) {
            int mid = (lo + hi) >> 1;
            if (lut.forward[mid] < target)
                lo = mid;
            else
                hi = mid;
        }
        float frac = (target - lut.forward[lo]) /
                     (lut.forward[hi] - lut.forward[lo] + 1e-12f);
        lut.inverse[i] = lo + frac * (hi - lo);
    }
    return lut;
}

constexpr LevelLUT levelLUT = buildLevelLUT();
constexpr float LEVEL_LUT_MAX = levelLUT.maxValue;

// ---- Accessors ----
inline IRAM_ATTR __attribute__((always_inline)) float rdxGain(float level) {
    int i = (int)level;
    float frac = level - i;
    return levelLUT.forward[i] +
           frac * (levelLUT.forward[i + 1] - levelLUT.forward[i]);
}

inline IRAM_ATTR __attribute__((always_inline)) float rdxGainInv(float value) {
    float scaled = value / LEVEL_LUT_MAX * (LEVEL_LUT_SIZE - 1);
    int i = (int)scaled;
    float frac = scaled - i;
    return levelLUT.inverse[i] +
           frac * (levelLUT.inverse[i + 1] - levelLUT.inverse[i]);
}



/*
constexpr float refaceGainFormula(int L) {
    return std::pow(10.0f, -((127 - L) * 48.0f) / (20.0f * 127.0f)) - 0.003981071705533f;
}

constexpr std::array<float, 192> makeRefaceGainTable() {
    std::array<float, 192> arr{};
    arr[0] = 0.0f;
    for (int i = 1; i < 192; ++i) {
        arr[i] = mapLevel(i);
    }
    return arr;
}

constexpr auto RDX_GAIN = makeRefaceGainTable();

inline __attribute__((always_inline)) constexpr float rdxGain(float L) {
   // return RDX_GAIN[(L >= 0 ? L : 0) & 127];
    int idx    = (int)L ;
    float frac = L - (float)idx;
    float s0   = RDX_GAIN[idx];
    return s0 + frac * (RDX_GAIN[(idx + 1) ] - s0);
}
*/


//----------------------- LFO SPEED ------------------------------

inline constexpr float LFO_SPEED[128] = {
    0.0263f, 0.0421f, 0.0841f, 0.1262f, 0.1682f, 0.2103f, 0.2524f, 0.2944f, 
    0.3364f, 0.3723f, 0.4120f, 0.4560f, 0.5047f, 0.5423f, 0.5827f, 0.6261f, 
    0.6728f, 0.7114f, 0.7523f, 0.7954f, 0.8411f, 0.8803f, 0.9213f, 0.9642f, 
    1.0091f, 1.0488f, 1.0901f, 1.1330f, 1.1776f, 1.2175f, 1.2588f, 1.3014f, 
    1.3455f, 1.3858f, 1.4273f, 1.4700f, 1.5140f, 1.5543f, 1.5956f, 1.6380f, 
    1.6815f, 1.7223f, 1.7640f, 1.8067f, 1.8505f, 1.8910f, 1.9323f, 1.9746f, 
    2.0178f, 2.0587f, 2.1006f, 2.1432f, 2.1867f, 2.2274f, 2.2689f, 2.3111f, 
    2.3540f, 2.3953f, 2.4372f, 2.4799f, 2.5233f, 2.5643f, 2.6060f, 2.6483f, 
    2.6914f, 2.7717f, 2.8545f, 2.9398f, 3.0276f, 3.1080f, 3.1906f, 3.2754f, 
    3.3625f, 3.4441f, 3.5277f, 3.6133f, 3.7010f, 3.8585f, 4.0228f, 4.1940f, 
    4.3725f, 4.5324f, 4.6981f, 4.8699f, 5.0480f, 5.2061f, 5.3693f, 5.5375f, 
    5.7110f, 6.0235f, 6.3530f, 6.7006f, 7.0671f, 7.3811f, 7.7089f, 8.0514f, 
    8.4090f, 8.7273f, 9.0575f, 9.4003f, 9.7561f, 10.2908f, 10.8548f, 11.4498f, 
    12.0773f, 12.7102f, 13.3762f, 14.0771f, 14.8148f, 15.4396f, 16.2486f, 17.1001f, 
    17.4764f, 18.5376f, 19.6633f, 20.8574f, 22.1239f, 23.3385f, 24.6198f, 25.9714f, 
    27.3973f, 28.9017f, 30.3030f, 31.6456f, 33.0033f, 34.3643f, 37.0370f, 39.6825f
};

//----------------------------- AM_DEPTH ------------------------------------
inline constexpr float AM_DEPTH[128] = { // 1/127 is closer )
    0.00000, 0.00065, 0.00130, 0.00156, 0.00195, 0.00260, 0.00325, 0.00390, 
    0.00519, 0.00649, 0.00779, 0.01039, 0.01169, 0.01299, 0.01558, 0.01818, 
    0.02078, 0.02338, 0.02597, 0.02857, 0.03117, 0.03506, 0.03766, 0.04156, 
    0.04545, 0.04935, 0.05325, 0.05714, 0.06104, 0.06623, 0.07013, 0.07532, 
    0.07922, 0.08442, 0.08961, 0.09481, 0.10130, 0.10649, 0.11299, 0.11818, 
    0.12468, 0.13117, 0.13636, 0.14286, 0.14935, 0.15584, 0.16364, 0.17013, 
    0.17792, 0.18571, 0.19351, 0.20130, 0.20909, 0.21688, 0.22468, 0.23377, 
    0.24221, 0.25065, 0.25974, 0.26883, 0.27792, 0.28701, 0.29740, 0.30649, 
    0.31688, 0.32597, 0.33636, 0.34675, 0.35714, 0.36753, 0.37857, 0.38961, 
    0.40065, 0.41169, 0.42338, 0.43506, 0.44675, 0.45844, 0.47013, 0.48247, 
    0.49481, 0.50649, 0.51883, 0.53247, 0.54481, 0.55714, 0.57143, 0.58312, 
    0.59740, 0.60909, 0.62338, 0.63636, 0.65065, 0.66494, 0.67792, 0.68961, 
    0.70519, 0.71948, 0.73247, 0.74805, 0.76364, 0.77792, 0.79091, 0.80260, 
    0.81818, 0.83506, 0.84675, 0.85844, 0.87662, 0.88961, 0.90260, 0.91169, 
    0.92338, 0.93117, 0.93896, 0.94805, 0.95714, 0.96623, 0.97532, 0.98312, 
    0.98857, 0.99026, 0.99182, 0.99351, 0.99506, 0.99675, 0.99831, 1.00000 
};

//------------------------------ PM_DEPTH -----------------------------------
inline constexpr float PM_DEPTH[128] = { 
    0.0000, 0.0053, 0.0107, 0.0161, 0.0216, 0.0270, 0.0325, 0.0381, 
    0.0436, 0.0492, 0.0549, 0.0605, 0.0662, 0.0719, 0.0777, 0.0835, 
    0.0893, 0.0952, 0.1011, 0.1070, 0.1130, 0.1190, 0.1250, 0.1311, 
    0.1372, 0.1434, 0.1495, 0.1557, 0.1620, 0.1683, 0.1746, 0.1810, 
    0.1874, 0.1938, 0.2003, 0.2068, 0.2133, 0.2199, 0.2265, 0.2332, 
    0.2399, 0.2466, 0.2534, 0.2602, 0.2671, 0.2740, 0.2809, 0.2879, 
    0.2949, 0.3020, 0.3090, 0.3162, 0.3234, 0.3306, 0.3379, 0.3452, 
    0.3525, 0.3599, 0.3673, 0.3748, 0.3824, 0.3899, 0.3975, 0.4052, 
    0.4129, 0.4206, 0.4284, 0.4362, 0.4441, 0.4521, 0.4600, 0.4680, 
    0.4761, 0.4842, 0.4924, 0.5006, 0.5088, 0.5171, 0.5255, 0.5339, 
    0.5423, 0.5508, 0.5594, 0.5680, 0.5766, 0.5853, 0.5941, 0.6029, 
    0.6117, 0.6206, 0.6296, 0.6386, 0.6476, 0.6567, 0.6659, 0.6751, 
    0.6844, 0.6937, 0.7031, 0.7125, 0.7220, 0.7315, 0.7411, 0.7508, 
    0.7605, 0.7702, 0.7801, 0.7899, 0.7999, 0.8099, 0.8199, 0.8300, 
    0.8402, 0.8504, 0.8607, 0.8710, 0.8815, 0.8919, 0.9025, 0.9130, 
    0.9237, 0.9344, 0.9452, 0.9560, 0.9669, 0.9779, 0.9889, 1.0000 
};

// semitones per second = level units per second
inline constexpr float PEG_SPEED[128] = {
	20.718, 20.917, 21.131, 21.361, 21.607, 21.871, 22.155, 22.459, 
    22.786, 23.137, 23.513, 23.917, 24.350, 24.816, 25.315, 25.851, 
    26.426, 27.044, 27.707, 28.418, 29.181, 30.000, 30.880, 31.823, 
    32.836, 33.923, 35.090, 36.342, 37.686, 39.128, 40.676, 42.338, 
    44.121, 46.035, 48.089, 50.294, 52.660, 55.200, 57.925, 60.851, 
    63.991, 67.360, 70.977, 74.859, 79.025, 83.496, 88.295, 93.446, 
    98.974, 104.907, 111.274, 118.109, 125.444, 133.316, 141.766, 150.834, 
    160.567, 171.013, 182.224, 194.257, 207.172, 221.032, 235.909, 251.875, 
    269.012, 287.403, 307.143, 328.329, 351.067, 375.471, 401.663, 429.774, 
    459.945, 492.327, 527.081, 564.382, 604.416, 647.383, 693.499, 742.993, 
    796.114, 853.128, 914.318, 979.992, 1050.478, 1126.129, 1207.322, 1294.465, 
    1387.993, 1488.374, 1596.109, 1711.739, 1835.841, 1969.035, 2111.990, 2265.418, 
    2430.088, 2606.824, 2796.510, 3000.094, 3218.595, 3453.105, 3704.798, 3974.934, 
    4264.862, 4576.033, 4910.004, 5268.446, 5653.151, 6066.044, 6509.190, 6984.805, 
    7495.269, 8043.136, 8631.145, 9262.238, 9939.571, 10666.534, 11446.762, 12284.158, 
    13182.911, 14147.516, 15182.798, 16293.937, 17486.490, 18766.422, 20140.136, 21614.504 
};


constexpr float AEG_SPEED[128] = {
    1.188327005, 1.425527005, 1.662727005, 1.899927005, 2.137127005, 2.374327005, 2.611527005, 2.848727005, 
    3.085927005, 3.323127005, 3.560327005, 3.797527005, 4.034727005, 4.271927005, 4.509127005, 4.746327005, 
    4.983527005, 5.220727005, 5.457927005, 5.695127005, 5.932327005, 7.892668796, 9.958848359, 12.13657982, 
    14.4318858, 16.85111408, 19.40095516, 22.08846076, 24.9210633, 27.90659649, 31.05331697, 34.36992715, 
    37.86559929, 41.55000083, 45.43332119, 49.52629987, 53.84025621, 58.38712067, 63.17946784, 68.23055119, 
    73.55433974, 79.1655567, 85.07972017, 91.31318606, 97.88319334, 104.8079117, 112.1064918, 119.7991181, 
    127.9070652, 136.4527558, 145.4598235, 154.9531779, 164.9590733, 175.5051814, 186.620668, 198.3362737, 
    210.6843984, 223.6991916, 237.4166463, 251.8746988, 267.1133336, 283.1746939, 300.1031981, 317.945663, 
    336.7514327, 356.5725156, 377.4637277, 399.4828449, 422.6907621, 447.1516619, 472.9331922, 500.1066531, 
    528.7471942, 558.9340223, 590.7506206, 624.2849795, 659.6298399, 696.8829499, 736.1473347, 777.531582, 
    821.1501419, 867.1236439, 915.5792299, 966.6509062, 1020.479914, 1077.215121, 1137.01343, 1200.040216, 
    1266.469784, 1336.485848, 1410.282041, 1488.062449, 1570.042178, 1656.447948, 1747.518718, 1843.506348, 
    1944.676298, 2051.308358, 2163.697423, 2282.154312, 2407.006623, 2538.599642, 2677.297295, 2823.483158, 
    2977.561515, 3139.958478, 3311.123163, 3491.528935, 3681.674715, 3882.086361, 4093.318121, 4315.954167, 
    4550.610211, 4797.935205, 5058.613139, 5333.364931, 5622.95042, 5928.170471, 6249.869183, 6588.936232, 
    6946.309323, 7322.976791, 7719.980328, 8138.417866, 8579.446616, 9044.286266, 9534.222351, 10050.60982 
};

constexpr int LFO_SEMITONE_LUT_ENTRIES = 256;
constexpr int LFO_SEMITONE_LUT_CENTER = LFO_SEMITONE_LUT_ENTRIES / 2;

// Precompute array
constexpr float DRAM_ATTR SEMITONE_LUT[LFO_SEMITONE_LUT_ENTRIES] = {
  6.151958e-04, 6.517773e-04, 6.905340e-04, 7.315953e-04, 7.750982e-04, 8.211879e-04, 8.700183e-04, 9.217523e-04, 
  9.765625e-04, 1.034632e-03, 1.096154e-03, 1.161335e-03, 1.230392e-03, 1.303555e-03, 1.381068e-03, 1.463191e-03, 
  1.550196e-03, 1.642376e-03, 1.740037e-03, 1.843505e-03, 1.953125e-03, 2.069264e-03, 2.192309e-03, 2.322670e-03, 
  2.460783e-03, 2.607109e-03, 2.762136e-03, 2.926381e-03, 3.100393e-03, 3.284752e-03, 3.480073e-03, 3.687009e-03, 
  3.906250e-03, 4.138528e-03, 4.384617e-03, 4.645340e-03, 4.921567e-03, 5.214218e-03, 5.524272e-03, 5.852762e-03, 
  6.200785e-03, 6.569503e-03, 6.960146e-03, 7.374018e-03, 7.812500e-03, 8.277055e-03, 8.769235e-03, 9.290681e-03, 
  9.843133e-03, 1.042844e-02, 1.104854e-02, 1.170552e-02, 1.240157e-02, 1.313901e-02, 1.392029e-02, 1.474804e-02, 
  1.562500e-02, 1.655411e-02, 1.753847e-02, 1.858136e-02, 1.968627e-02, 2.085687e-02, 2.209709e-02, 2.341105e-02, 
  2.480314e-02, 2.627801e-02, 2.784058e-02, 2.949607e-02, 3.125000e-02, 3.310822e-02, 3.507694e-02, 3.716272e-02, 
  3.937253e-02, 4.171375e-02, 4.419417e-02, 4.682210e-02, 4.960628e-02, 5.255603e-02, 5.568117e-02, 5.899214e-02, 
  6.250000e-02, 6.621644e-02, 7.015388e-02, 7.432544e-02, 7.874507e-02, 8.342749e-02, 8.838835e-02, 9.364419e-02, 
  9.921257e-02, 1.051121e-01, 1.113623e-01, 1.179843e-01, 1.250000e-01, 1.324329e-01, 1.403078e-01, 1.486509e-01, 
  1.574901e-01, 1.668550e-01, 1.767767e-01, 1.872884e-01, 1.984251e-01, 2.102241e-01, 2.227247e-01, 2.359686e-01, 
  2.500000e-01, 2.648658e-01, 2.806155e-01, 2.973018e-01, 3.149803e-01, 3.337100e-01, 3.535534e-01, 3.745768e-01, 
  3.968503e-01, 4.204482e-01, 4.454494e-01, 4.719372e-01, 5.000000e-01, 5.297315e-01, 5.612310e-01, 5.946036e-01, 
  6.299605e-01, 6.674199e-01, 7.071068e-01, 7.491535e-01, 7.937005e-01, 8.408964e-01, 8.908987e-01, 9.438743e-01, 
  1.000000e+00, 1.059463e+00, 1.122462e+00, 1.189207e+00, 1.259921e+00, 1.334840e+00, 1.414214e+00, 1.498307e+00, 
  1.587401e+00, 1.681793e+00, 1.781797e+00, 1.887749e+00, 2.000000e+00, 2.118926e+00, 2.244924e+00, 2.378414e+00, 
  2.519842e+00, 2.669680e+00, 2.828427e+00, 2.996614e+00, 3.174802e+00, 3.363586e+00, 3.563595e+00, 3.775497e+00, 
  4.000000e+00, 4.237852e+00, 4.489848e+00, 4.756828e+00, 5.039684e+00, 5.339359e+00, 5.656854e+00, 5.993228e+00, 
  6.349604e+00, 6.727171e+00, 7.127190e+00, 7.550995e+00, 8.000000e+00, 8.475705e+00, 8.979696e+00, 9.513657e+00, 
  1.007937e+01, 1.067872e+01, 1.131371e+01, 1.198646e+01, 1.269921e+01, 1.345434e+01, 1.425438e+01, 1.510199e+01, 
  1.600000e+01, 1.695141e+01, 1.795939e+01, 1.902731e+01, 2.015874e+01, 2.135744e+01, 2.262742e+01, 2.397291e+01, 
  2.539842e+01, 2.690869e+01, 2.850876e+01, 3.020398e+01, 3.200000e+01, 3.390282e+01, 3.591879e+01, 3.805463e+01, 
  4.031747e+01, 4.271488e+01, 4.525483e+01, 4.794583e+01, 5.079683e+01, 5.381737e+01, 5.701752e+01, 6.040796e+01, 
  6.400000e+01, 6.780564e+01, 7.183757e+01, 7.610926e+01, 8.063495e+01, 8.542975e+01, 9.050967e+01, 9.589165e+01, 
  1.015937e+02, 1.076347e+02, 1.140350e+02, 1.208159e+02, 1.280000e+02, 1.356113e+02, 1.436751e+02, 1.522185e+02, 
  1.612699e+02, 1.708595e+02, 1.810193e+02, 1.917833e+02, 2.031873e+02, 2.152695e+02, 2.280701e+02, 2.416318e+02, 
  2.560000e+02, 2.712226e+02, 2.873503e+02, 3.044370e+02, 3.225398e+02, 3.417190e+02, 3.620387e+02, 3.835666e+02, 
  4.063747e+02, 4.305390e+02, 4.561401e+02, 4.832636e+02, 5.120000e+02, 5.424451e+02, 5.747006e+02, 6.088740e+02, 
  6.450796e+02, 6.834380e+02, 7.240773e+02, 7.671332e+02, 8.127493e+02, 8.610779e+02, 9.122803e+02, 9.665273e+02, 
  1.024000e+03, 1.084890e+03, 1.149401e+03, 1.217748e+03, 1.290159e+03, 1.366876e+03, 1.448155e+03, 1.534266e+03
};

// Semitones offset to ratio
inline IRAM_ATTR __attribute__((always_inline)) float semitonesToRatio(float offset) {
    float idxf = offset + (float)LFO_SEMITONE_LUT_CENTER;
    int idx    = (int)idxf ; // no guards cause we use 256 entries array, while theoretical max offset is 48 + 24 = 72, which equals 144 + 1 entries
    float s0 = SEMITONE_LUT[idx];
    return s0 + (idxf - (float)idx) * (SEMITONE_LUT[idx + 1] - s0);
}

constexpr float harmonics[8] = {
    1.000000f,   // H1
    0.0045644f,  // H2
    0.0044668f,  // H3
    0.0011220f,  // H4
    0.0006309f,  // H5
    0.0002512f,  // H6
    0.0000891f,  // H7
    0.0000501f   // H8
};

constexpr float INV_SIZE = 1.0f / float(SINLUT_SIZE);

// Build LUT at compile-time
constexpr auto buildTable() {
    std::array<float, SINLUT_SIZE+1> t{};
    for (int i = 0; i < SINLUT_SIZE+1; ++i) {
        float phase = float(i) * TWO_PI * INV_SIZE;
        t[i] = std::sin(phase) 
               + harmonics[1] * std::sin(phase * 2.0f)
               + harmonics[2] * std::sin(phase * 3.0f)
               + harmonics[3] * std::sin(phase * 4.0f)
               + harmonics[4] * std::sin(phase * 5.0f)
               + harmonics[5] * std::sin(phase * 6.0f)
               + harmonics[6] * std::sin(phase * 7.0f)
               + harmonics[7] * std::sin(phase * 8.0f);
    }
    return t;
}

//constexpr auto sinTable = buildTable();
DRAM_ATTR const std::array<float, SINLUT_SIZE+1> sinTable = buildTable();
 
// phase in [0..1), output [-1..1]
inline IRAM_ATTR __attribute__((always_inline)) float sin01(float phase) {
    float idxf = phase * SINLUT_SIZE;
    int idx    = (int)idxf ;
    float frac = idxf - (float)idx;
    float s0   = sinTable[idx];
    return s0 + frac * (sinTable[(idx + 1) ] - s0);
}


constexpr float DELAY_TIME_MS[128] = {
    11.6, 19.9, 28.0, 36.2, 44.3, 52.5, 60.6, 68.8, 
    77.0, 85.2, 93.3, 101.5, 109.6, 117.8, 125.9, 134.1, 
    142.3, 150.4, 158.6, 166.7, 174.9, 183.0, 191.2, 199.3, 
    207.4, 215.6, 223.7, 231.9, 240.1, 248.2, 256.4, 264.6, 
    272.8, 280.9, 289.0, 297.2, 305.3, 313.5, 321.6, 329.7, 
    337.9, 346.0, 354.2, 362.3, 370.4, 378.6, 386.7, 394.9, 
    403.0, 411.2, 419.3, 427.5, 435.7, 443.8, 452.0, 460.2, 
    468.3, 479.4, 490.5, 501.6, 512.7, 523.7, 534.8, 545.9, 
    557.0, 567.2, 577.4, 587.7, 597.9, 608.1, 618.3, 628.5, 
    638.8, 648.9, 659.1, 669.2, 679.4, 689.5, 699.7, 709.8, 
    720.0, 730.3, 740.6, 750.9, 761.3, 771.6, 781.9, 792.2, 
    802.5, 812.7, 822.9, 833.1, 843.3, 853.4, 863.6, 873.8, 
    884.0, 894.3, 904.5, 914.8, 925.0, 935.3, 945.5, 955.8, 
    966.0, 976.3, 986.5, 996.8, 1007.0, 1017.3, 1027.5, 1037.8, 
    1048.0, 1058.2, 1068.4, 1078.6, 1088.9, 1099.1, 1109.3, 1119.5, 
    1129.7, 1139.9, 1150.1, 1160.3, 1170.6, 1180.8, 1191.0, 1201.0 
};


constexpr float FEEDBACK_K[128] = {
    0.002, 0.003267426, 0.004557163, 0.005869603, 0.007205146, 0.0085642, 0.009947176, 0.011354498,
    0.012786592, 0.014243896, 0.015726853, 0.017235915, 0.018771541, 0.020334199, 0.021924365, 0.023542523,
    0.025189165, 0.026864793, 0.028569918, 0.030305058, 0.032070742, 0.033867507, 0.035695902, 0.037556482,
    0.039449813, 0.041376474, 0.04333705, 0.045332138, 0.047362345, 0.049428291, 0.051530604, 0.053669925,
    0.055846904, 0.058062205, 0.060316502, 0.062610481, 0.064944842, 0.067320295, 0.069737564, 0.072197384,
    0.074700504, 0.077247688, 0.079839709, 0.082477359, 0.085161439, 0.087892768, 0.090672177, 0.093500512,
    0.096378634, 0.099307421, 0.102287763, 0.105320569, 0.108406761, 0.111547281, 0.114743083, 0.117995141,
    0.121304446, 0.124672005, 0.128098844, 0.131586006, 0.135134553, 0.138745565, 0.142420143, 0.146159404,
    0.149964489, 0.153836555, 0.157776781, 0.161786368, 0.165866536, 0.170018528, 0.174243608, 0.178543062,
    0.182918201, 0.187370355, 0.191900882, 0.19651116, 0.201202593, 0.205976611, 0.210834666, 0.215778238,
    0.220808833, 0.225927982, 0.231137243, 0.236438205, 0.24183248, 0.247321711, 0.252907569, 0.258591757,
    0.264376004, 0.270262071, 0.276251753, 0.282346871, 0.288549282, 0.294860876, 0.301283573, 0.30781933,
    0.314470137, 0.321238019, 0.328125037, 0.335133288, 0.342264906, 0.349522063, 0.356906969, 0.364421873,
    0.372069062, 0.379850866, 0.387769654, 0.395827838, 0.404027871, 0.41237225, 0.420863517, 0.429504256,
    0.4382971, 0.447244725, 0.456349857, 0.465615268, 0.475043779, 0.484638261, 0.494401636, 0.504336878,
    0.514447011, 0.524735113, 0.535204319, 0.545857816, 0.556698848, 0.567730716, 0.57895678, 0.590380457
};

constexpr float VELO_SENS[128] = {
    0.063095734, 0.063095734, 0.065770417, 0.068538064, 0.071400889, 0.074361105, 0.07742093, 0.080582578, 
    0.083848258, 0.087220172, 0.090700511, 0.09429145, 0.097995147, 0.101813739, 0.105749336, 0.109804022, 
    0.113979845, 0.118278819, 0.122702913, 0.127254055, 0.131934121, 0.136744933, 0.141688256, 0.146765789, 
    0.151979166, 0.157329948, 0.162819616, 0.168449573, 0.17422113, 0.180135509, 0.186193835, 0.192397128, 
    0.198746302, 0.205242159, 0.211885384, 0.218676536, 0.22561605, 0.232704225, 0.239941225, 0.247327069, 
    0.254861629, 0.262544624, 0.270375615, 0.278354002, 0.286479018, 0.294749724, 0.303165006, 0.311723571, 
    0.32042394, 0.329264448, 0.338243238, 0.347358259, 0.356607261, 0.365987793, 0.375497198, 0.385132615, 
    0.394890972, 0.404768986, 0.414763161, 0.424869787, 0.435084936, 0.445404464, 0.455824011, 0.466338998, 
    0.476944628, 0.487635885, 0.498407541, 0.509254147, 0.520170043, 0.531149357, 0.542186005, 0.553273698, 
    0.56440594, 0.575576035, 0.586777092, 0.598002023, 0.609243554, 0.620494227, 0.631746406, 0.642992281, 
    0.654223879, 0.665433063, 0.676611546, 0.687750895, 0.698842537, 0.709877771, 0.720847772, 0.731743602, 
    0.742556221, 0.753276489, 0.763895183, 0.774403004, 0.784790583, 0.795048497, 0.805167277, 0.815137415, 
    0.824949381, 0.834593626, 0.844060598, 0.85334075, 0.86242455, 0.871302494, 0.879965112, 0.888402978, 
    0.896606723, 0.90456704, 0.912274691, 0.91972052, 0.926895452, 0.933790502, 0.940396776, 0.946705476, 
    0.952707895, 0.958395414, 0.963759493, 0.968791661, 0.97348349, 0.977826568, 0.981812457, 0.985432627, 
    0.988678368, 0.991540653, 0.99400993, 0.99607578, 0.997726321, 0.998947018, 0.999717752, 1.0 
};

